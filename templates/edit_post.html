{% extends "base.html" %}


{% block content %}

<div class="col span_2_of_3">

  <form id="edit_form" method="POST">
    <input type="hidden" id="post_id" name="post_id" value="{{ post.id or 'new' }}"/>
    <input type="hidden" name="post_type" value="{{ post.post_type }}"/>


    {% if post.draft   %}
      <input style="padding: 10px" type="button" id="save_draft_button" value="Save Draft"/>
      <input style="padding: 10px" type="button" id="publish_button" value="Publish"/>
    {% else %}
      <input style="padding: 10px" type="button" id="save_draft_button" value="Un-Publish"/>
      <input style="padding: 10px" type="button" id="publish_button" value="Re-Publish"/>
    {% endif %}

    {% if post.post_type == 'article' %}
      <div class="title">
        <label><span class="heading">Title</span><input name="title" size="60" value="{{ post.title or '' }}"/></label>
      </div>
      <div class="slug">
        <label><span class="heading">Slug</span><input name="slug" size="60" value="{{ post.slug or ''}}"/></label>
      </div>
    {% endif %}

    {% if post.post_type == 'reply' %}
      <div class="in_reply_to">
        <label><span class="heading">In Reply To (URL)</span><input name="in_reply_to" size="60" value="{{post.in_reply_to or ''}}"/></label>
      </div>
    {% endif %}

    {% if post.post_type == 'share' %}
      <div class="repost_source">
        <label><span class="heading">Repost (URL)</span><input name="repost_source" size="60" value="{{post.repost_source or ''}}"/></label>
      </div>
    {% endif %}

    {% if post.post_type == 'like' %}
      <div class="like_of">
        <label><span class="heading">Like of (URL)</span><input name="like_of" size="60" value="{{post.like_of or ''}}"/></label>
      </div>
    {% endif %}

    <div class="content">
      <textarea name="content" id="content" style="width:100%" rows="{{ 30 if post.post_type == 'article' else 5 }}">{{ post.content }}</textarea>
    </div>

    <p>
      <select name="content_format" id="content_format">
        <option {% if post.content_format == "markdown" %}selected{% endif %}>markdown</option>
        <option {% if post.content_format == "plain" %}selected{% endif %}>plain</option>
        <option {% if post.content_format == "html" %}selected{% endif %}>html</option>
      </select>

      <label><input type="checkbox" id="send_to_twitter" name="send_to_twitter" value="true" {% if False and post.id is none %}checked{% endif %}/>Share on Twitter</label>
      <label><input type="checkbox" id="send_to_facebook" name="send_to_facebook" value="true" {% if False and post.id is none %}checked{% endif %}/>Share on Facebook</label>
      <label><input type="checkbox" id="send_webmentions" name="send_webmentions" value="true" {% if post.id is none %}checked{% endif %}/>Send Webmentions</label>
    </p>

    {% if advanced %}
      <div class="twitter_status_id">
        <label><span class="heading">Twitter Status ID</span><input name="twitter_status_id" size="60" value="{{post.twitter_status_id or ''}}"></label>
      </div>
      <div class="facebook_post_id">
        <label><span class="heading">Facebook Post ID</span><input name="facebook_post_id" size="60" value="{{post.facebook_post_id or ''}}"></label>
      </div>
    {% endif %}

  </form>

  <form id="image_upload">
    <label>
      <span class="heading">Add Image:</span><input type="file" id="image_upload_button" text="Add Image" accept="image/*"></input>
    </label>
  </form>

  <!-- <a href="#" id="uploads_link">Uploads</a> -->
</div>

<div class="col span_1_of_3">
  <ul id="result"></ul>
</div>

<!--
<div class="col span_3_of_3">
     <iframe id="preview" style="display: none;width: 100%"></iframe>
</div>
-->

<script src="http://code.jquery.com/jquery-1.11.0.min.js"></script>
<script type="text/javascript" src="{{url_for('static', filename='js/editor.js')}}"></script>
<script type="text/javascript">


$(document).ready(function() {
    $("#image_upload_button").change(function() {
        var file = this.files[0];
        $('#result').append("<li>uploading file " + file.name + "</li>");

        if (undefined != file) {
            var formData = new FormData();
            formData.append('file', file);

            $.ajax({
                url: '/api/upload_file',
                type: 'POST',
                success: completeHandler,
                data: formData,
                cache: false,
                contentType: false,
                processData: false
            });
        }
    });

    function completeHandler(data) {
        var content_text_area = $("#content");
        var content_format = $("#content_format").val();

        if (content_format == 'markdown') {
            content_text_area.val( content_text_area.val() + '\n![](' + data.path + ')');
        }
        else {
            content_text_area.val( content_text_area.val() + '\n<img src="' + data.path + '"/>');
        }
    }

});

</script>
{% endblock %}
